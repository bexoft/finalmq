<html>                                                                          


<head>                                                                          

<script type="text/javascript" src="fmq.js"></script>

                                                                                
<script type="text/javascript" >

//////////////////////////////////////////////////////////////////////


var g_fmqSession = new FmqSession();
var g_fmqQtService = null;
var g_fmqQtInvoker = null;

class Events extends FmqEntity
{
    allRequests(correlationId, path, params)
    {
        var elCounter = document.getElementById(path + '/counter');
        if (elCounter)
        {
            var counter = parseInt(elCounter.innerHTML);
            counter++;
            elCounter.innerHTML = counter;
        }
        var elValue = document.getElementById(path + '/value');
        if (elValue)
        {
            elValue.innerHTML = params.fmqparamsjson;
        }
        var elProp = document.getElementById(path + '/prop');
        if (elProp)
        {
            elProp.innerHTML = params.fmqparamsjson;
        }
    }

    sessionDisconnected()
    {
    }

    sessionConnected()
    {
    }

    serverDisconnected()
    {
    }

    serverConnected()
    {
    }
}



function getObjectName(obj)
{
	for (var i = 0; i < obj.properties.length; i++)
	{
		var prop = obj.properties[i];
        if (prop.name == 'objectName')
        {
            return JSON.parse(prop.value).v;
        }
    }
    return '';
}


function iterateObjects(obj, level, idParent)
{
    var table = '<table border="1">';
    
    table += '<tr>';
    table += '<td>Image</td>';
    table += '<td>Class Chain</td>';
    table += '<td>Properties</td>';
    table += '<td>Methods</td>';
    table += '<td>Children</td>';
    table += '</tr>';

    objectName = getObjectName(obj);

    // Class Chain
    table += '<tr>';

    table += '<td id="' + objectName + '/img">'
    table += '</td>';    

    table += '<td>'
	for (var i = 0; i < obj.classchain.length; i++)
    {
		var className = obj.classchain[i];
        table += className;
        table += '<br/>';
    }
    table += '</td>';

    // properties
    table += '<td><table border="1">';
	for (var i = 0; i < obj.properties.length; i++)
	{
		var prop = obj.properties[i];
        table += '<tr>';
        table += '<td>' + prop.type + '</td>';
        table += '<td>' + prop.name + '</td>';
        if (prop.hasNotifySignal)
        {
            var id = objectName + '/' + prop.signal;
            table += '<td id="' + id + '/prop">' + prop.value.substr(0, 100) + '</td>';
            table += '<td>' + prop.signal + '</td>';
        }
        else
        {
        table += '<td>' + prop.value.substr(0, 100) + '</td>';
            table += '<td>-</td>';
        }

        if (prop.name == 'size')
        {
            var size = JSON.parse(prop.value);
            var params = {rectangle:{left:0,top:0,right:size.v.width,bottom:size.v.height}};
            g_fmqQtInvoker.requestReply(objectName + '/grab(QRect)', params, function(outparams, objectName) {
                var elImg = document.getElementById(objectName+'/img');
                if (elImg)
                {
                    elImg.innerHTML = '<img style="position:relative; left:'+0+'; top:'+0+'; width:'+size.v.width+'; height:'+size.v.height+';" src="data:image/png;base64,' + outparams.v + '"></img>';
                }
            }, objectName);

        }

        table += '</tr>';
    }
    table += '</table></td>';

    // Methods
    table += '<td><table border="1">';
	for (var i = 0; i < obj.methods.length; i++)
    {
        var method = obj.methods[i];
        table += '<tr>';
        table += '<td>' + method.name + '</td>';
        table += '<td>' + method.index + '</td>';
        table += '<td>' + method.access + '</td>';
        table += '<td>' + method.methodType + '</td>';
        table += '<td>' + method.signature + '</td>';
        table += '<td>' + method.returnType.typeName + '</td>';

        // Parameters
        table += '<td><table border="1">';
        for (var j = 0; j < method.parameters.length; j++)
        {
            var parameter = method.parameters[j];
            table += '<tr>';
            table += '<td>' + parameter.name + '</td>';
            table += '<td>' + parameter.typeName + '</td>';
            table += '<td>' + parameter.typeId + '</td>';
            table += '</tr>';
        }
                
        table += '</table></td>';

        if (method.methodType == 'Signal')
        {
            var id = objectName + '/' + method.signature;
            
            table += '<td id="' + id + '/counter">' + 0 + '</td>';
            g_fmqQtInvoker.requestReply(objectName + '/connect_' + method.signature, null, function(outparams) {});
            table += '<td id="' + id + '/value"></td>';
        }

        table += '</tr>';
    }
    table += '</table></td>';
    
    // Children
    table += '<td><table border="1">';
	for (var i = 0; i < obj.children.length; i++)
    {
        var id = idParent + '.' + i;
        table += '<tr>';
        table += '<td id="'+ id +'">';
        table += '</td>';
        table += '</tr>';
    }
    table += '</table></td>';

    table += '</tr>';
    
    document.getElementById(idParent).innerHTML = table;

	for (var i = 0; i < obj.children.length; i++)
    {
        var id = idParent + '.' + i;
        iterateObjects(obj.children[i], level + 1, id);
    }
}


function poll()
{
	getObjectTree();
}

function getObjectTree()
{
    g_fmqQtService.requestReply('finalmq.qt.GetObjectTreeRequest', null, function(outparams) {
        if (outparams.fmqheader.status == 'STATUS_OK')
        {
			document.getElementById('root').innerHTML = '';
            iterateObjects(outparams.root, 0, 'root', null);
        }
    });
}



function fmqReady()
{
	poll();
	//setInterval(poll, 2000);
}


function pageLoad()
{
    g_fmqSession.createSession(function() {
		g_fmqQtService = g_fmqSession.createEntity('QtService');
		g_fmqQtInvoker = g_fmqSession.createEntity('QtInvoker', Events);
        fmqReady();
    });
}

function pageUnload()
{
    g_fmqSession.removeSession();
}
												 
												 
</script>                                                                       
                                                                          

</head>

                                                               
<body onload="pageLoad()" onunload="pageUnload()">





<div style="position:absolute; top:0; left:0; width:100%; height:100%;">
	<div style="position:absolute; top:0; left:0; width:100%; height:100%;" id="root">
	</div>	
</div>


</body>


</html>
       
