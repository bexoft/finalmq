<html>                                                                          


<head>                                                                          

<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="fmq.js"></script>

                                                                                
<script type="text/javascript" >

//////////////////////////////////////////////////////////////////////


var g_fmqEntity = new FmqEntity();

function getProperty(properties, key)
{
	for (var i = 0; i < properties.length; i++)
	{
		var prop = properties[i];
		if (prop.name == key)
		{
			return prop['value'];
		}
	}
	return null;
}


function isDerivedFrom(obj, className)
{
	for (var i = 0; i < obj.classchain.length; i++)
	{
		var classNameIter = obj.classchain[i];
		if (classNameIter == className)
		{
			return true;
		}
	}
	return false;
}

function insertProperties(id, obj)
{
	propstext = '';
	for (var i = 0; i < obj.properties.length; i++)
	{
		var prop = obj.properties[i];
		propstext += prop.name + '=' + prop.value+';';
	}
	insertComment(id, propstext);
}


function iterateObjects(obj, level, idParent)
{
	var id = idParent;
	if (isDerivedFrom(obj, 'QAbstractButton'))
	{
		var x = getProperty(obj.properties, 'x');
		var y = getProperty(obj.properties, 'y');
		var width = getProperty(obj.properties, 'width');
		var height = getProperty(obj.properties, 'height');
		var visible = getProperty(obj.properties, 'visible');
		
		if (visible == 'true')
		{
			id = insertButton(idParent, x, y, width, height, getProperty(obj.properties, 'objectName'));
			insertText(id, obj.classchain[0])
			insertText(id, '<br>')
			insertText(id, getProperty(obj.properties, 'objectName'))
			insertText(id, '<br>')
			insertText(id, getProperty(obj.properties, 'text'))
			insertProperties(id, obj);
		}
	}
	else if (isDerivedFrom(obj, 'QWidget'))
	{
		if (isDerivedFrom(obj, 'ScrollBar'))
		{
			var t=0;
		}
		var x = getProperty(obj.properties, 'x');
		var y = getProperty(obj.properties, 'y');
		var width = getProperty(obj.properties, 'width');
		var height = getProperty(obj.properties, 'height');
		var visible = getProperty(obj.properties, 'visible');
		
		if (visible == 'true')
		{
			id = insertBox(idParent, x, y, width, height);
			insertText(id, obj.classchain[0])
			insertText(id, '<br>')
			insertText(id, getProperty(obj.properties, 'objectName'))
			insertText(id, '<br>')
			insertText(id, getProperty(obj.properties, 'text'))
			if (getProperty(obj.properties, 'html'))
			{
				insertText(id, '<br>')
				insertText(id, getProperty(obj.properties, 'html'))
			}
			insertProperties(id, obj);
		}
	}
	else if (isDerivedFrom(obj, 'QLayout'))
	{
		var x = getProperty(obj.properties, 'x');
		var y = getProperty(obj.properties, 'y');
		var width = getProperty(obj.properties, 'width');
		var height = getProperty(obj.properties, 'height');
		var enabled = getProperty(obj.properties, 'enabled');
		
		if (enabled == '1')
		{
			id = insertBox(idParent, x, y, width, height);
			insertText(id, obj.classchain[0])
			insertText(id, '<br>')
			insertText(id, getProperty(obj.properties, 'objectName'))
			insertProperties(id, obj);
		}
	}
	
	for (var i = 0; i < obj.children.length; i++)
	{
		var child = obj.children[i];
		if (isDerivedFrom(child, 'QLayout'))
		{
			iterateObjects(child, level + 1, id);
		}
	}
	for (var i = 0; i < obj.children.length; i++)
	{
		var child = obj.children[i];
		if (!isDerivedFrom(child, 'QAbstractButton') && !isDerivedFrom(child, 'QLayout'))
		{
			iterateObjects(child, level + 1, id);
		}
	}
	for (var i = 0; i < obj.children.length; i++)
	{
		var child = obj.children[i];
		if (isDerivedFrom(child, 'QAbstractButton'))
		{
			iterateObjects(child, level + 1, id);
		}
	}
}


function poll()
{
	getObjectTree();
	getScreenshot();
}

function getObjectTree()
{
    g_fmqEntity.requestReply('QtService', 'finalmq.qt.GetObjectTreeRequest', null, function(outparams) {
        if (outparams.replystatus == 'STATUS_OK')
        {
			document.getElementById('root').innerHTML = '';
            iterateObjects(outparams.root, 0, 'root');
        }
    });
}

function getScreenshot()
{
    g_fmqEntity.requestReply('QtService', 'finalmq.qt.GetScreenshotRequest', null, function(outparams) {
        if (outparams.replystatus == 'STATUS_OK')
        {
			document.getElementById('image').innerHTML = '<img style="position:absolute; left:'+outparams.x+'; top:'+outparams.y+'; width:'+outparams.width+'; height:'+outparams.height+';" src="data:image/png;base64,'+outparams.screen+'"></img>'
        }
    });
}


function pressButton(objectName)
{
	var inparams = {objectName:objectName};
    g_fmqEntity.requestReply('QtService', 'finalmq.qt.PressButtonRequest', inparams, function(outparams) {
		var t=0;
	});
}


function fmqReady()
{
	poll();
	setInterval(poll, 1000);
}


function pageLoad()
{
    g_fmqEntity.createEntity(function() {
        fmqReady();
    });
}

function pageUnload()
{
    g_fmqEntity.removeEntity(function() {});
}

var nextItemId = 0;

function insertBox(idParent, x, y, w, h)
{
	nextItemId++;
	var id = 'itemid' + nextItemId;
	var box = createBox(x, y, w, h, id);
	insertItem(idParent, box);
	return id;
}

function insertButton(idParent, x, y, w, h, objectName)
{
	nextItemId++;
	var id = 'itemid' + nextItemId;
	var button = createButton(x, y, w, h, id, objectName);
	insertItem(idParent, button);
	return id;
}

function insertText(idParent, text)
{
	insertItem(idParent, text);
}

function insertComment(idParent, text)
{
	insertItem(idParent, '<!--'+text+'-->');
}

function insertItem(idParent, item)
{
	document.getElementById(idParent).innerHTML += item;
}
                                       
function createBox(x, y, w, h, id)
{
	var box = '<div style="position:absolute; color:rgb(0,155,155); left:'+x+'px; top:'+y+'px; width:'+w+'px; height:'+h+'px; border-width:1px; border-style:solid" id="'+id+'"></div>';
	return box;
}

function createButton(x, y, w, h, id, objectName)
{
	var button = '<button style="position:absolute; opacity:0.5; left:'+x+'px; top:'+y+'px; width:'+w+'px; height:'+h+'px;" id="'+id+'" onmousedown="pressButton(\''+objectName+'\')"></button>';
	return button;
}

												 
</script>                                                                       
                                                                          
</head>

                                                               
<body>                                                                          

<body onload="pageLoad()" onunload="pageUnload()">
<div style="position:absolute; top:0; left:0; width:100%; height:100%;">
	<div style="position:absolute; top:0; left:0; width:100%; height:100%;" id="image">
	</div>
	<div style="position:absolute; top:0; left:0; width:100%; height:100%;" id="root">
	</div>
</div>

</body>


</html>
       
